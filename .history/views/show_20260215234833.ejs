<!DOCTYPE html>
<html lang="en" class="scroll-smooth" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Posts | Modern Feed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#dc2626',      // red-600 accent
            primarydark: '#b91c1c',
          }
        }
      }
    }
  </script>
  <style>
    [data-theme="light"] {
      --bg: #f8fafc;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
    }
    [data-theme="dark"] {
      --bg: #0f172a;
      --card: #1e293b;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --border: #334155;
    }
    body {
      background: var(--bg);
      color: var(--text);
    }
    .card-hover {
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    .card-hover:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.3);
    }
    .glass {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }
  </style>
</head>
<body class="min-h-screen font-sans antialiased">

  <!-- Navbar - Glassmorphic -->
  <nav class="fixed top-0 left-0 right-0 z-50 glass border-b border-[var(--border)]">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="/" class="text-2xl font-bold bg-gradient-to-r from-primary to-primarydark bg-clip-text text-transparent">
          Posts
        </a>

        <div class="flex items-center gap-4">
          <!-- Theme Toggle -->
          <button id="theme-toggle" class="p-2 rounded-full hover:bg-white/10 transition">
            <i id="theme-icon" class="bi bi-moon-stars-fill text-xl"></i>
          </button>

          <!-- Account -->
          <% if (currentUser) { %>
            <div class="relative group">
              <button class="flex items-center gap-2 focus:outline-none">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-primary to-primarydark flex items-center justify-center text-white font-bold shadow-md">
                  <%= (currentUser.username || currentUser.email || 'U').charAt(0).toUpperCase() %>
                </div>
                <span class="hidden md:block font-medium"><%= currentUser.username || currentUser.email?.split('@')[0] %></span>
              </button>

              <div class="absolute right-0 mt-2 w-48 bg-[var(--card)] border border-[var(--border)] rounded-xl shadow-2xl opacity-0 group-hover:opacity-100 invisible group-hover:visible transition-all duration-200">
                <a href="/profile" class="block px-4 py-3 hover:bg-white/5 rounded-t-xl">Profile</a>
                <a href="/settings" class="block px-4 py-3 hover:bg-white/5">Settings</a>
                <hr class="border-[var(--border)]">
                <form action="/logout" method="POST">
                  <button type="submit" class="w-full text-left px-4 py-3 text-red-400 hover:bg-white/5 rounded-b-xl">Logout</button>
                </form>
              </div>
            </div>
          <% } else { %>
            <a href="/login" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primarydark transition">Login</a>
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-24 pb-16">

    <!-- Debug (remove later) -->
    <div class="mb-8 p-4 bg-white/5 backdrop-blur-md border border-[var(--border)] rounded-xl text-sm">
      Debug: Logged in as <strong><%= currentUser ? (currentUser.username || currentUser.email) : 'Guest' %></strong>
    </div>

    <!-- Posts Grid - Modern Card Style -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
      <% if (alldata && alldata.length > 0) { %>
        <% alldata.forEach(data => { %>
          <div class="card-hover group relative overflow-hidden rounded-2xl shadow-xl bg-[var(--card)] border border-[var(--border)]">
            <!-- Image with Gradient Overlay -->
            <% if (data.img?.url) { %>
              <div class="relative h-64 overflow-hidden">
                <img src="<%= data.img.url %>" alt="<%= data.name || 'Post'" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
                <div class="absolute bottom-4 left-4 right-4 text-white">
                  <h3 class="text-xl font-bold drop-shadow-md"><%= data.name || 'Untitled' %></h3>
                </div>
              </div>
            <% } else { %>
              <div class="h-64 bg-gradient-to-br from-gray-800 to-gray-900 flex items-center justify-center text-gray-400">
                <i class="bi bi-image text-6xl opacity-50"></i>
              </div>
            <% } %>

            <div class="p-6">
              <div class="flex flex-wrap gap-2 mb-4">
                <span class="px-3 py-1 bg-primary/20 text-primary text-sm rounded-full"><%= data.deg || 'Degree' %></span>
                <span class="px-3 py-1 bg-gray-700/50 text-gray-300 text-sm rounded-full"><%= data.age ? data.age + ' yrs' : 'Age N/A' %></span>
              </div>

              <p class="text-[var(--muted)] text-sm mb-4">
                Posted by <span class="text-white/80"><%= data.owner?.username || data.owner?.email || 'Anonymous' %></span>
              </p>

              <% if (currentUser && currentUser._id?.toString() === data.owner?._id?.toString()) { %>
                <div class="flex gap-3 mt-6">
                  <a href="/api/update/<%= data._id %>" class="flex-1 text-center py-2 bg-yellow-500/20 hover:bg-yellow-500/40 text-yellow-400 rounded-lg transition">Update</a>
                  <form action="/api/delete/<%= data._id %>?_method=DELETE" method="POST" class="flex-1">
                    <button type="submit" onclick="return confirm('Pakka delete?')" class="w-full py-2 bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded-lg transition">Delete</button>
                  </form>
                </div>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <div class="col-span-full text-center py-20 text-[var(--muted)]">
          <i class="bi bi-emoji-frown text-6xl mb-4 block opacity-50"></i>
          <p class="text-xl">Koi post nahi mila bhai...</p>
          <a href="/api/new" class="mt-4 inline-block px-6 py-3 bg-primary text-white rounded-xl hover:bg-primarydark transition">Pehla post daal do!</a>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    const html = document.documentElement;
    const toggle = document.getElementById('theme-toggle');
    const icon = document.getElementById('theme-icon');

    function setTheme(isDark) {
      if (isDark) {
        html.classList.add('dark');
        html.setAttribute('data-theme', 'dark');
        icon.className = 'bi bi-sun-fill text-xl';
      } else {
        html.classList.remove('dark');
        html.setAttribute('data-theme', 'light');
        icon.className = 'bi bi-moon-stars-fill text-xl';
      }
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    // Load saved or system preference
    let theme = localStorage.getItem('theme');
    if (!theme) {
      theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    setTheme(theme === 'dark');

    toggle.addEventListener('click', () => {
      const current = html.getAttribute('data-theme') === 'dark';
      setTheme(!current);
    });
  </script>
</body>
</html>